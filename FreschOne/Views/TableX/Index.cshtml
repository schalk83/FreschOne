@model FreschOne.Models.TableViewModel
@{
    var userid = ViewBag.userid;
    var readwriteaccess = ViewBag.readwriteaccess;
    var tablename = ViewBag.tablename;
    var PKColumn = ViewBag.PKColumn;
    var tableDescription = ViewBag.tableDescription;
}

<partial name="_Sidebar" />

<h1 class="mb-4">Data for @tableDescription</h1>

<div class="d-flex justify-content-between align-items-center mb-2">
    @if (readwriteaccess == "RW")
    {
        <a href="@Url.Action("Create", new { userid = Model.UserId, tablename = Model.TableName })" class="btn custom-button btn-blue">
            <i class="bi bi-plus-circle-fill"></i> Create
        </a>
    }
    <button id="toggleSearchBtn" class="btn btn-sm btn-outline-primary" onclick="toggleSearch()">+ Show Search</button>
</div>

<table class="table table-bordered table-hover align-middle" id="dataTable">
    <thead class="table-light">
        <tr>
            @foreach (var column in Model.Columns)
            {
                string formattedColumn = System.Text.RegularExpressions.Regex.Replace(column.Replace("ID", ""), "(?<=.)([A-Z])", " $1");
                if (column.StartsWith("attachment_")) { formattedColumn = column.Replace("attachment_", ""); }

                <th class="fixed-width" data-column="@column">@formattedColumn</th>
            }
            <th>Actions</th>
        </tr>
        <tr id="searchRow" style="display: none;">
            @foreach (var column in Model.Columns)
            {
                string formattedColumn = System.Text.RegularExpressions.Regex.Replace(column.Replace("ID", ""), "(?<=.)([A-Z])", " $1");

                <th class="fixed-width">
                    @if (column.StartsWith("attachment_"))
                    {
                        <select class="form-control column-search" data-column="@column">
                            <option value="">All</option>
                            <option value="true">With Attachment</option>
                            <option value="false">No Attachment</option>
                        </select>
                    }
                    else
                    {
                        <input type="text" class="form-control column-search" data-column="@column" placeholder="Search @formattedColumn" />
                    }
                </th>
            }
            <th></th>
        </tr>
    </thead>
    <tbody id="tableBody">
        @foreach (var row in Model.TableData)
        {
            <tr>
                @foreach (var column in Model.Columns)
                {
                    var value = row[column]?.ToString() ?? "";
                    <td class="fixed-width" data-column="@column" data-sort="@value">
                        @if (column.StartsWith("attachment_"))
                        {
                            <div class="text-center">
                                @{
                                    var parts = value.Split(';');
                                    var desc = parts[0].Trim();
                                    var url = parts.Length > 1 ? parts[1].Trim().Replace("\\", "/") : "";
                                    if (!string.IsNullOrWhiteSpace(url))
                                    {
                                        <a href="@Url.Content("~/" + url)" target="_blank">@desc</a>
                                    }
                                    else
                                    {
                                        @desc
                                    }
                                }
                            </div>
                        }
                        else
                        {
                            @value
                        }
                    </td>
                }
                <td class="text-center align-middle">
                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                        @if (readwriteaccess == "RW")
                        {
                            <a href="@Url.Action("Edit", new { id = row["ID"], tablename, userid, pageNumber = ViewBag.pageNumber })"
                               class="custom-button btn-gold">
                                <i class="bi bi-pencil-fill"></i> Edit
                            </a>
                            <button type="button" class="custom-button btn-red" onclick="confirmDelete(@row["ID"], '@tablename')">
                                <i class="bi bi-trash-fill"></i> Delete
                            </button>
                        }
                        @if (readwriteaccess == "R")
                        {
                            <a href="@Url.Action("Edit", new { id = row["ID"], tablename, userid, pageNumber = ViewBag.pageNumber })"
                               class="custom-button btn-gold">
                                <i class="bi bi-eye-fill"></i> View
                            </a>
                        }
                        <button class="custom-button btn-green" onclick="showPopup(event, '@tablename', '@row["ID"]')">
                            <i class="bi bi-link-45deg"></i> More
                        </button>
                    </div>
                </td>

            </tr>
        }
    </tbody>
</table>

<!-- Pagination Controls -->
<div class="d-flex justify-content-center mt-3">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            @if (ViewBag.pageNumber > 1)
            {
                <li class="page-item"><a class="page-link" href="@Url.Action("Index", "TableX", new { userid, tablename, pageNumber = 1 })">First</a></li>
                <li class="page-item"><a class="page-link" href="@Url.Action("Index", "TableX", new { userid, tablename, pageNumber = ViewBag.pageNumber - 1 })">&laquo; Prev</a></li>
            }
            @for (var i = Math.Max(1, ViewBag.pageNumber - 2); i <= Math.Min(ViewBag.totalPages, ViewBag.pageNumber + 2); i++)
            {
                <li class="page-item @(i == ViewBag.pageNumber ? "active" : "")">
                    <a class="page-link" href="@Url.Action("Index", "TableX", new { userid, tablename, pageNumber = i })">@i</a>
                </li>
            }
            @if (ViewBag.pageNumber < ViewBag.totalPages)
            {
                <li class="page-item"><a class="page-link" href="@Url.Action("Index", "TableX", new { userid, tablename, pageNumber = ViewBag.pageNumber + 1 })">Next &raquo;</a></li>
                <li class="page-item"><a class="page-link" href="@Url.Action("Index", "TableX", new { userid, tablename, pageNumber = ViewBag.totalPages })">Last</a></li>
            }
        </ul>
    </nav>
</div>

<!-- Delete Modal -->
<div class="modal" tabindex="-1" id="deleteModal" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deactivation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Are you sure you want to deactivate this record? This action cannot be undone.</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Confirm</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Popup -->
<div id="popup" class="popup" style="display:none;">
    <div id="popup-content" class="popup-content"></div>
</div>


@section Scripts {
    <script>
        // Sorting
        document.querySelectorAll("#dataTable th[data-column]").forEach(header => {
            header.style.cursor = "pointer";
            header.addEventListener("click", () => {
                const table = header.closest("table");
                const tbody = table.querySelector("tbody");
                const rows = Array.from(tbody.querySelectorAll("tr"));
                const columnIndex = Array.from(header.parentNode.children).indexOf(header);
                const sortAsc = !header.classList.contains("asc");

                rows.sort((a, b) => {
                    let cellA = a.children[columnIndex];
                    let cellB = b.children[columnIndex];
                    let valA = cellA.getAttribute("data-sort") || cellA.innerText.trim();
                    let valB = cellB.getAttribute("data-sort") || cellB.innerText.trim();
                    if (!isNaN(valA) && !isNaN(valB)) return sortAsc ? valA - valB : valB - valA;
                    return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                });

                rows.forEach(row => tbody.appendChild(row));
                table.querySelectorAll("th").forEach(th => th.classList.remove("asc", "desc"));
                header.classList.add(sortAsc ? "asc" : "desc");
            });
        });

        // Filter
        function filterTable() {
            const inputs = document.querySelectorAll('.column-search');
            const rows = document.querySelectorAll("#tableBody tr");
            rows.forEach(row => {
                let visible = true;
                inputs.forEach(input => {
                    const col = input.getAttribute("data-column");
                    const val = input.value.toLowerCase();
                    const cell = row.querySelector(`td[data-column="${col}"]`);
                    if (cell && val && !cell.innerText.toLowerCase().includes(val)) {
                        visible = false;
                    }
                });
                row.style.display = visible ? "" : "none";
            });
        }

        // Toggle search row
        function toggleSearch() {
            const row = document.getElementById("searchRow");
            const btn = document.getElementById("toggleSearchBtn");
            row.style.display = row.style.display === "none" ? "table-row" : "none";
            btn.innerText = row.style.display === "none" ? "+ Show Search" : "- Hide Search";
        }

        // Delete logic
        function confirmDelete(recordId, tableName) {
            $('#deleteModal').modal('show');
            $('#confirmDeleteBtn').off('click').on('click', function () {
                $('#deleteModal').modal('hide');
                $.ajax({
                    url: '@Url.Action("Delete", "TableX")',
                    method: 'POST',
                    data: { id: recordId, tablename: tableName, userid: @userid },
                    success: function () { location.reload(); },
                    error: function () { alert('Error deleting record'); }
                });
            });
        }

        // Related table popup
        function showPopup(event, tablename, id) {
            let currentUrl = window.location.href;
            fetch(`/TableX/ForeignTables_Index?tablename=${tablename}&userid=${@userid}&isAjax=true`)
                .then(response => response.json())
                .then(data => {
                    let popup = document.getElementById('popup');
                    let content = `<table class="table"><thead><tr><th>Related Table</th><th></th></tr></thead><tbody>`;
                    data.forEach(record => {
                        const url = `/TableY/Index?userid=${@userid}&tablename=${record.ChildTable}&PKID=${id}&PKColumn=${record.PKColumn}&returnUrl=${encodeURIComponent(currentUrl)}`;
                        content += `<tr class="clickable-row" data-url="${url}" style="cursor:pointer;"><td>${record.ChildTableDescription}</td><td></td></tr>`;
                    });
                    content += `</tbody></table>`;
                    document.getElementById('popup-content').innerHTML = content;
                    popup.style.display = 'block';

                    const rect = event.target.getBoundingClientRect();
                    popup.style.left = rect.left + window.scrollX + 'px';
                    popup.style.top = rect.top + window.scrollY + 40 + 'px';

                    document.querySelectorAll(".clickable-row").forEach(row => {
                        row.addEventListener("click", function () {
                            window.location.href = this.getAttribute("data-url");
                        });
                    });
                });
        }

        // Close popup on outside click
        document.addEventListener('click', function (e) {
            const popup = document.getElementById('popup');
            if (popup.style.display === 'block' && !popup.contains(e.target) && !e.target.closest('.btn')) {
                popup.style.display = 'none';
            }
        });

        document.querySelectorAll('.column-search').forEach(input => {
            input.addEventListener("keyup", filterTable);
            input.addEventListener("change", filterTable);
        });
    </script>
}
